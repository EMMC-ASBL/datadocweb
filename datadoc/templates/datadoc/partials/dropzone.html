
<form action="{% url 'datadoc:upload_files' %}" class="dropzone mb-3" id="files-dropzone">
  {% csrf_token %}
</form>

<div id="results"></div>

<div id="upload-result" style="display: none;">
<div class="alert alert-{color} alert-dismissible fade show" role="alert" id="file-{uuid}">
  <strong>{status}</strong> for file "{file}": {message}
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
</div>

{% block scripts %}
<script>
function showUploadResult(response, file) {
  let html = $('#upload-result').html();
  if (response.status_code == 200) {
    html = html.replace('{status}', 'Success');
    html = html.replace('{color}', 'success');
  } else {
    html = html.replace('{status}', 'Error');
    html = html.replace('{color}', 'danger');
  }
  html = html.replace('{file}', file.name);
  html = html.replace('{uuid}', file.upload.uuid);
  html = html.replace('{message}', response.message);
  $('#results').append(html);
  if (response.status_code == 200) {
    var fid = `#file-${file.upload.uuid}`;
    window.setTimeout(() => { $(fid).remove(); }, 5000);
  }
}

Dropzone.options.filesDropzone = {
  paramName: "files",
  maxFilesize: 10, // MB
  timeout: 1800000, // 30 minutes,
  acceptedFiles: '.csv,.json,.yaml',
  init: function() {
    this.on("success", (file, response) => {
      if (response) {
        showUploadResult(response, file);
      }
      return file.previewElement.classList.add("dz-success");
    });
    this.on("error", (file, response) => {
      if (response) {
        showUploadResult(response, file);
      }
      return file.previewElement.classList.add("dz-error");
    });
    this.on("complete", (file) => {
      this.removeFile(file);
    });
  }      
};

</script>
{% endblock %}
