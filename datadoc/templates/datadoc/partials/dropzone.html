
<form action="{% url 'datadoc:upload_files' %}" class="dropzone mb-3" id="files-dropzone">
  {% csrf_token %}
</form>

<div class="alert alert-info" role="alert">
  For Excel files, only worksheets where cell A1 contains <strong>@id</strong>
  will be uploaded. The first row must define the column headers, and headers
  must not end with a number (e.g. <strong>@type.1</strong> is not allowed).
</div>

<div id="results">

</div>

<div id="upload-result" style="display: none;">
<div class="alert alert-{color} alert-dismissible fade show" role="alert" id="file-{uuid}">
  <strong>{status}</strong> for file "{file}": {message}
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
</div>

{% block scripts %}
<script>

function formatString(template, values) {
  return template.replace(/{(\w+)}/g, (_, key) => values[key] ?? `{${key}}`);
}

function getAndReplace(htmlId, values, appendTo) {
  let html = $(htmlId).html();
  let newhtml = formatString(html, values);
  if (appendTo) {
    $(appendTo).append(newhtml);
  }
  return newhtml;
}

function showUploadResult(response, file) {
  let values = {
    status: 'Error',
    color: 'danger',
    file: file.name,
    uuid: file.upload.uuid,
    message: response.message
  };
  if (response.status_code == 200) {
    values.status = 'Success';
    values.color = 'success';
  }
  if (Array.isArray(response.message)) {
    let items = response.message;
    let msg = '';
    let ul = '';
    items.forEach(item => {
      if (item.startsWith('- ')) {
        ul += `<li>${item.substring(2)}</li>`;
      } else {
        msg += item;
      }
    });
    values.message = ul ? `${msg}<ul>${ul}</ul>` : msg;
  }

  getAndReplace('#upload-result', values, '#results');

  if (response.status_code == 200) {
    var fid = `#file-${file.upload.uuid}`;
    window.setTimeout(() => { $(fid).remove(); }, 5000);
  }
}

Dropzone.options.filesDropzone = {
  paramName: "files",
  maxFilesize: 10, // MB
  timeout: 1800000, // 30 minutes,
  acceptedFiles: '.xlsx,.csv,.json,.yaml',
  init: function() {
    this.on("success", (file, response) => {
      if (response) {
        showUploadResult(response, file);
      }
      return file.previewElement.classList.add("dz-success");
    });
    this.on("error", (file, response) => {
      if (response) {
        showUploadResult(response, file);
      }
      return file.previewElement.classList.add("dz-error");
    });
    this.on("complete", (file) => {
      this.removeFile(file);
    });
  }      
};

</script>
{% endblock %}
