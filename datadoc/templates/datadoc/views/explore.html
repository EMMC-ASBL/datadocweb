{% extends datadoc_base_template %}

{% block content %}
<div class="container-fluid mt-4">
  <div class="row">
    <div class="col-3">
      <div class="card">
        <div class="card-header">
          Filters
        </div>
        <div class="card-body">
          <div class="btn-group btn-group-sm" role="group">
            <div class="btn-group btn-group-sm" role="group">
              <button type="button" class="btn btn-light dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                Add
              </button>
              <ul class="dropdown-menu" style="max-height: 300px; overflow-y: auto;">
                {% for item in filters.items %}
                <li><button id="btn_{{ item.name }}" type="button"
                            class="dropdown-item" onclick="onAdd(this)"
                            data-criteria="{{ item.value }}">
                  {{ item.text }}
                </button></li>
                {% endfor %}
              </ul>
            </div>
            <div class="btn-group btn-group-sm" role="group">
              <button type="button" class="btn btn-light dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                Remove
              </button>
              <ul class="dropdown-menu" id="menu-remove">
                {% for item in filters.selected %}
                <li><button id="btn_remove_{{ item.name }}" type="button"
                            class="dropdown-item" onclick="onRemove(this)"
                            data-criteria="{{ item.value }}">
                  {{ item.text }}
                </button></li>
                {% endfor %}
              </ul>
            </div>
            <button type="button" class="btn btn-light" onclick="onReset()">Reset</button>
            <button type="button" class="btn btn-light" onclick="onApply(this)">Apply</button>
          </div>            
          <form id="search-filters">
            {% csrf_token %}
            {% for item in filters.selected %}
              <div class="mt-1">
                <label for="{{ item.name }}" class="form-label form-text">{{ item.text }}</label>
                <select class="form-select form-select-sm" id="{{ item.name }}"
                        name="{{ item.name }}">
                  {% for choice in item.choices %}
                    <option value="{{ choice.value }}" {% if choice.selected %}selected{% endif %}>{{ choice.text }}</option>
                  {% endfor %}      
                </select>
              </div>              
            {% endfor %}
          </form>
        </div>
      </div>
    </div>
    <div class="col-9" style="padding-left: 0px;">
      <div class="card">
        <div class="card-header">
          Search results
          <div id="spinner" class="spinner-border spinner-border-sm" role="status" style="display:none">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
        <div class="card-body">
          {% if error %}
          <div id="search-error">
            <div style="margin-top: 10px; margin-bottom: 0px;"
                role="alert"
                class="alert alert-warning alert-dismissible fade show">
              <strong>Error!</strong> {{ error }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          </div>
          {% elif table %}
          <div id="search-result">
            <div class="text-nowrap mb-3" style="overflow-x: auto">
              <table id="result" class="table table-bordered table-sm">
                <thead>
                  <tr>{% for col in table.cols %}<th>{{ col }}</th>{% endfor %}</tr>
                </thead>
                <tbody>
                  {% for row in table.rows %}
                  <tr>{% for cell in row %}<td {{ cell.attrs|safe }}>{% if cell.href %}{% include 'datadoc/components/link.html' with data=cell %}{% else %}{{ cell.text }}{% endif %}</td>{% endfor %}</tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% include 'datadoc/components/pagination.html' %}
          </div>
          {% elif query %}
          <div id="search-result-none">
            <p>no results matched with your query</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

<div id="input-criteria" style="display:none">
  <div class="mt-1">
    <label for="{id}" class="form-label form-text">{label}</label>
    <select class="form-select form-select-sm" id="{id}" name="{id}"
            data-criteria="{criteria}">
    </select>
  </div>
</div>

<div id="button-remove" style="display:none">
  <li><button id="btn_remove_{id}" type="button" class="dropdown-item"
              onclick="onRemove(this)" data-criteria="{criteria}">
    {label}
  </button></li>
</div>

</div>

{% endblock %}
{% block scripts %}
<script>

  function getToken() {
    let items = $('#search-filters').serializeArray(); 
    let item = items.find(x => x.name == 'csrfmiddlewaretoken');
    return item ? item.value : '';
  }

  function formatString(template, values) {
    return template.replace(/{(\w+)}/g, (_, key) => values[key] ?? `{${key}}`);
  }

  function onAdd(btn) {
    let select_id = btn.id.substring(4);
    if ($(`#${select_id}`).length == 0) {
      let text = $(btn).text().trim();
      let criteria = $(btn).data('criteria');

      let values = {id: select_id, label: text, criteria: criteria};
      let html = $('#input-criteria').html();
      $('#search-filters').append(formatString(html, values));

      html = $('#button-remove').html();
      $('#menu-remove').append(formatString(html, values));

      $.ajax({
        type: "POST",
        url: "{% url 'datadoc:explore' %}",
        headers: {'X-CSRFToken': getToken()},
        dataType: 'json',
        data: {name: select_id , criteria: criteria},
        success: (response) => {
          console.log(response)
          if (response.choices) {
            let opt = response.choices.map(x => {
              return `<option value="${x.value}">${x.text}</option>`;
            });
            $(`#${response.name}`).empty().append(opt);
          }
        }
      });
    }
  }

  function onRemove(btn) {    
    let select_id = btn.id.substring(11);

    if ($(`#${select_id}`).length == 1) {

      $(btn).parent().remove();
      $(`#${select_id}`).parent().remove();

      let criteria = $(btn).data('criteria');
      $.ajax({
        type: "DELETE",
        url: `{% url 'datadoc:explore' %}?criteria=${encodeURIComponent(criteria)}`,
        headers: {'X-CSRFToken': getToken()},
        success: (response) => {
          console.log(response)
        }
      });
    }
  }

  function onApply(page) {
    $('#spinner').show();
    let items = $('#search-filters').serializeArray();
    let params = new URLSearchParams();
    items.forEach(item => {
      if (item.name != 'csrfmiddlewaretoken') {
        if (item.value != '--- none ---') {
          params.set(item.name, item.value);
        }
      }
    });
    if (page) {
      params.set('page', page);
    }
    if (params.size > 0) {
      location.href = `{% url 'datadoc:explore' %}?${params.toString()}`;
    } else {
      location.href = "{% url 'datadoc:explore' %}";
    }
  }

  function onReset() {
    $('#spinner').show();
    location.href = "{% url 'datadoc:explore' %}";
  }

  function onPage(num) {
    onApply(num);
  }

  function onPrevPage() {
    let page = Number($('.page-item.active').first().text().trim());
    onPage(page - 1);
  }

  function onNextPage() {
    let page = Number($('.page-item.active').first().text().trim());
    onPage(page + 1);
  }

</script>
{% endblock %}
