{% extends 'datadoc/base.html' %}
{% block content %}
{% include 'datadoc/components/header.html' %}

<main>
    <style>
        .btn-add,
        .btn-edit,
        .btn-submit,
        .btn-delete {
            background-color: #858885;
            color: white;
            border: none;
        }

        .btn-add:hover,
        .btn-edit:hover,
        .btn-submit:hover,
        .btn-delete:hover {
            background-color: #3f4140;
            color: white;
            border: none;
        }

        .btn-delete {
            background-color: #dc3545;
        }

        .btn-delete:hover {
            background-color: #c82333;
        }

        .btn-edit {
            background-color: #84ff0094;
        }

        .btn-edit:hover {
            background-color: #84ff0094;
        }
    </style>

    <body class="p-4">
        <div class="container">
            <h2 class="mb-4">Documentation Form</h2>
            <div class="d-flex ">
                <button type="button" class="btn btn-add me-2" onclick="addColumn()">‚ûï Add Column</button>
                <button type="button" class="btn btn-add" onclick="addRow()">‚ûï Add Row</button>
            </div>

            <table class="table table-bordered" id="dataTable">
                <thead>
                    <tr id="tableHeadings">
                    </tr>
                </thead>
                <tbody id="tableRows">
                </tbody>
            </table>

            <div id="submitButtonContainer" class="justify-content-end" style="display: none;">
                <button type="button" class="btn btn-submit" onclick="generateCSV()">Submit Documentation</button>
            </div>

        </div>

        <div id="successModal" class="modal fade" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content" id="modalContent">
                </div>
            </div>
        </div>

        <script>
            let columns = [];
            let rows = [];

            function addColumn() {
                const columnName = "Column " + (columns.length + 1);
                columns.push(columnName);
                rows.forEach(row => {
                    row[columnName] = '';
                });
                updateTable();
            }

            function addRow() {
                if (columns.length === 0) {
                    alert("Please add at least one column before adding a row.");
                    return;
                }
                const newRow = {};
                columns.forEach(col => {
                    newRow[col] = '';
                });
                rows.push(newRow);
                updateTable();
            }

            function updateTable() {
                const tableHeadings = document.getElementById('tableHeadings');
                tableHeadings.innerHTML = '';

                const submitContainer = document.getElementById('submitButtonContainer');
                const shouldShowButton = columns.length > 0 && rows.length > 0;
                submitContainer.style.display = shouldShowButton ? 'flex' : 'none';

                columns.forEach((col, colIndex) => {
                    const th = document.createElement('th');
                    th.innerHTML = `
                        <div class="d-flex justify-content-between">
                            <input type="text" value="${col}" onchange="renameColumn(${colIndex}, this.value)" />
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteColumn(${colIndex})">üóëÔ∏è</button>
                        </div>
                    `;
                    tableHeadings.appendChild(th);
                });

                tableHeadings.appendChild(document.createElement('th'));

                const tableRows = document.getElementById('tableRows');
                tableRows.innerHTML = '';

                rows.forEach((row, rowIndex) => {
                    const tr = document.createElement('tr');
                    columns.forEach(col => {
                        const td = document.createElement('td');
                        td.innerHTML = `<input type="text" value="${row[col]}" onchange="updateRowValue(${rowIndex}, '${col}', this.value)" />`;
                        tr.appendChild(td);
                    });

                    const actionsTd = document.createElement('td');
                    const deleteButton = document.createElement('button');
                    deleteButton.classList.add('btn', 'btn-sm', 'btn-outline-danger');
                    deleteButton.innerHTML = 'üóëÔ∏è';
                    deleteButton.onclick = () => {
                        rows.splice(rowIndex, 1);
                        updateTable();
                    };
                    actionsTd.appendChild(deleteButton);
                    tr.appendChild(actionsTd);
                    tableRows.appendChild(tr);
                });
            }

            function renameColumn(colIndex, newName) {
                const oldName = columns[colIndex];
                columns[colIndex] = newName;

                rows.forEach(row => {
                    row[newName] = row[oldName];
                    delete row[oldName];
                });

                updateTable();
            }

            function deleteColumn(colIndex) {
                const colName = columns[colIndex];
                columns.splice(colIndex, 1);
                rows.forEach(row => {
                    delete row[colName];
                });

                updateTable();
            }

            function updateRowValue(rowIndex, colName, newValue) {
                rows[rowIndex][colName] = newValue;
            }

            function validateTable() {
                for (let i = 0; i < rows.length; i++) {
                    for (let j = 0; j < columns.length; j++) {
                        if (!rows[i][columns[j]]) {
                            alert("Please fill in all fields before saving the CSV.");
                            return false;
                        }
                    }
                }
                return true;
            }

            function generateCSV() {
                if (!validateTable()) {
                    return;
                }
                if (columns.length === 0 || rows.length === 0) {
                    alert("Please add some columns and rows first!");
                    return;
                }
                let csvContent = columns.join(",") + "\n";
                rows.forEach(row => {
                    const rowValues = columns.map(col => row[col]);
                    csvContent += rowValues.join(",") + "\n";
                });
                fetch('{% url "process_csv" %}', {
                    method: 'POST',
                    headers: {
                        'HX-Request': 'true',
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `csv_data=${encodeURIComponent(csvContent)}`
                })
                    .then(response => response.json())
                    .then(data => {
                        showModal(data);
                    })
            }

            function showModal(response) {
                const modalElement = document.getElementById('successModal');
                const modalContent = document.getElementById('modalContent');

                modalContent.innerHTML = `
                    <div class="modal-header">
                        <h5 class="modal-title">${response.status === 'Success' ? 'Success' : 'Error'}</h5>
                    </div>
                    <div class="modal-body">
                        <p>${response.message}</p>
                        <p>Status Code: ${response.status_code}</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="closeModal()">Close</button>
                    </div>
                `;

                const modalInstance = new bootstrap.Modal(modalElement);
                modalInstance.show();
            }

            function closeModal() {
                columns = [];
                rows = [];
                updateTable();
                document.getElementById('tableHeadings').innerHTML = '';
                document.getElementById('tableRows').innerHTML = '';
                document.getElementById('modalContent').innerHTML = '';
                document.getElementById('submitButtonContainer').style.display = 'none';
            }
        </script>

    </body>
</main>
{% endblock %}