{% extends 'datadoc/base.html' %}
{% block content %}
{% include 'datadoc/components/header.html' %}
<div class="container mt-4">
  <h2 class="mb-4">Documentation Form</h2>
  <div class="btn-toolbar" role="toolbar">
    <div class="btn-group btn-group-sm me-2" role="group">
      <button type="button" class="btn btn-secondary" onclick="addColumn()">
        Add column
      </button>
      <button type="button" class="btn btn-secondary" onclick="addRow()">
        Add row
      </button>
    </div>
    <div class="btn-group btn-group-sm me-2" role="group">
      <button type="button" class="btn btn-secondary" disabled>Remove column</button>
      <button type="button" class="btn btn-secondary" disabled>Remove rows</button>
    </div>
    <div class="btn-group btn-group-sm" role="group">
      <button id="btn-submit" type="button" class="btn btn-success" onclick="generateCSV()">
        Submit
      </button>
    </div>
  </div>
  <div id="warn-alert" class="alert alert-warning alert-dismissible fade show mt-2" role="alert" style="display:none">
    <span id="warn-message">Message</span>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
  <table class="table table-bordered mt-2" id="dataTable">
    <thead>
      <tr id="tableHeadings"></tr>
    </thead>
    <tbody id="tableRows">
    </tbody>
  </table>
</div>
{% include 'datadoc/components/dialog.html' %}
<script>
  let columns = [];
  let rows = [];

  function showWarning(message) {
    $('#warn-message').text(message);
    $('#warn-alert').show();
  }

  function addColumn() {
    const columnName = "Column " + (columns.length + 1);
    columns.push(columnName);
    rows.forEach(row => {
      row[columnName] = '';
    });
    updateTable();
  }

  function addRow() {
    if (columns.length === 0) {
      showWarning("Please add at least one column before adding a row.");
      return;
    }
    const newRow = {};
    columns.forEach(col => {
      newRow[col] = '';
    });
    rows.push(newRow);
    updateTable();
  }

  function updateTable() {
    const tableHeadings = document.getElementById('tableHeadings');
    tableHeadings.innerHTML = '';

    columns.forEach((col, colIndex) => {
      const th = document.createElement('th');
      th.innerHTML = `
        <div class="d-flex justify-content-between">
            <input type="text" value="${col}" onchange="renameColumn(${colIndex}, this.value)" />
            <button class="btn btn-sm btn-outline-danger" onclick="deleteColumn(${colIndex})">
              <i class="bi bi-trash3"></i>
            </button>
        </div>
      `;
      tableHeadings.appendChild(th);
    });

    tableHeadings.appendChild(document.createElement('th'));

    const tableRows = document.getElementById('tableRows');
    tableRows.innerHTML = '';

    rows.forEach((row, rowIndex) => {
      const tr = document.createElement('tr');
      columns.forEach(col => {
        const td = document.createElement('td');
        td.innerHTML = `<input type="text" value="${row[col]}" onchange="updateRowValue(${rowIndex}, '${col}', this.value)" />`;
        tr.appendChild(td);
      });

      const actionsTd = document.createElement('td');
      const deleteButton = document.createElement('button');
      deleteButton.classList.add('btn', 'btn-sm', 'btn-outline-danger');
      deleteButton.innerHTML = '<i class="bi bi-trash3"></i>';
      deleteButton.onclick = () => {
        rows.splice(rowIndex, 1);
        updateTable();
      };
      actionsTd.appendChild(deleteButton);
      tr.appendChild(actionsTd);
      tableRows.appendChild(tr);
    });
  }

  function renameColumn(colIndex, newName) {
    const oldName = columns[colIndex];
    columns[colIndex] = newName;

    rows.forEach(row => {
      row[newName] = row[oldName];
      delete row[oldName];
    });

    updateTable();
  }

  function deleteColumn(colIndex) {
    const colName = columns[colIndex];
    columns.splice(colIndex, 1);
    rows.forEach(row => {
      delete row[colName];
    });

    updateTable();
  }

  function updateRowValue(rowIndex, colName, newValue) {
    rows[rowIndex][colName] = newValue;
  }

  function validateTable() {
    for (let i = 0; i < rows.length; i++) {
      for (let j = 0; j < columns.length; j++) {
        if (!rows[i][columns[j]]) {
          showWarning("Please fill in all fields before saving the CSV.");
          return false;
        }
      }
    }
    return true;
  }

  function generateCSV() {
    if (!validateTable()) {
      return;
    }
    if (columns.length === 0 || rows.length === 0) {
      showWarning("Please add some columns and rows first!");
      return;
    }
    let csvContent = columns.join(",") + "\n";
    rows.forEach(row => {
      const rowValues = columns.map(col => row[col]);
      csvContent += rowValues.join(",") + "\n";
    });
    fetch('{% url "process_csv" %}', {
      method: 'POST',
      headers: {
        'HX-Request': 'true',
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: `csv_data=${encodeURIComponent(csvContent)}`
    })
      .then(response => response.json())
      .then(data => {
        showDialog(data.message, data.status_code);
      })
  }
</script>
{% endblock %}