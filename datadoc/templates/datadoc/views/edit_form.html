{% extends 'datadoc/base.html' %}
{% block content %}
{% include 'datadoc/components/header.html' %}
<div class="container mt-4">
  <h3 class="mb-4">Documentation Form</h3>
  <div class="btn-toolbar" role="toolbar">
    <div class="btn-group btn-group-sm me-2" role="group">
      <button type="button" class="btn btn-secondary" onclick="addColumn()">
        Add column
      </button>
      <button type="button" class="btn btn-secondary" onclick="addRow()">
        Add row
      </button>
    </div>
    <div class="btn-group btn-group-sm me-2" role="group">
      <div class="btn-group btn-group-sm" role="group">
        <button type="button" class="btn btn-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
          Remove column
        </button>
        <ul class="dropdown-menu" id="remove-column"></ul>
      </div>
      <button type="button" class="btn btn-secondary" title="Remove the selected rows" onclick="deleteRows()">
        Remove rows
      </button>
    </div>
    <div class="btn-group btn-group-sm" role="group">
      <div class="btn-group btn-group-sm" role="group">
        <button id="btn-prefix" type="button" class="btn btn-secondary dropdown-toggle" data-bs-toggle="dropdown"
          aria-expanded="false">
          Prefix
        </button>
        <ul class="dropdown-menu" id="prefix">
          <li>
            <h6 class="dropdown-header">New prefix</h6>
          </li>
          <li><a class="dropdown-item" href="javascript:onAddPrefix()">Add</a></li>
          <li>
            <h6 class="dropdown-header">Remove prefix</h6>
          </li>
          {% for item in prefix_list %}
           <li><a class="dropdown-item" href="javascript:onRemovePrefix('{{ item.prefix }}')">{{ item.prefix }}: {{ item.iri }}</a></li>
          {% endfor %}
        </ul>
      </div>
    </div>
    <div class="btn-group btn-group-sm me-2 ms-2" role="group">
      <button type="button" class="btn btn-secondary" onclick="viewPrefixes()">View Available Prefixes</button>
    </div>
    <div class="btn-group btn-group-sm  ms-auto" role="group">
      <button id="btn-copy" type="button" class="btn btn-light me-2 ms-2" onclick="copyCSV()">
        Copy CSV
      </button>
      <button id="btn-submit" type="button" class="btn btn-success" onclick="submitCSV()">
        Submit
      </button>
    </div>
  </div>
  <div class="modal fade" id="prefixModal" tabindex="-1" aria-labelledby="prefixModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="prefixModalLabel">Available Prefixes</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p><b><i>If you don't find the required prefix below , Please use Add from Prefix dropdown to set prefix's for
                your documentation</i></b> </p>
          <ul id="prefix-list" class="list-group">
          </ul>
        </div>
      </div>
    </div>
  </div>
  <div id="warn-alert" class="alert alert-warning alert-dismissible fade show mt-2" role="alert" style="display:none">
    <span id="warn-message">Message</span>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
  <div class="row" id="row-prefix" style="display: none;">
    <hr class="mt-3">
    <form class="row row-cols-lg-auto align-items-center">
      <div class="col-12">
        <label class="visually-hidden" for="inp-prefix">Prefix</label>
        <div class="input-group input-group-sm">
          <div class="input-group-text">Prefix</div>
          <input type="text" class="form-control" id="inp-prefix" placeholder="Enter prefix">
        </div>
      </div>
      <div class="col-12" style="padding-left: 0px;">
        <label class="visually-hidden" for="inp-iri">IRI</label>
        <div class="input-group input-group-sm">
          <div class="input-group-text">IRI</div>
          <input type="text" class="form-control" id="inp-iri" placeholder="Enter IRI">
        </div>
      </div>
      <div class="col-12" style="padding-left: 0px;">
        <button type="button" class="btn btn-light btn-sm" onclick="hidePrefix()">Cancel</button>
        <button type="button" class="btn btn-primary btn-sm" onclick="addPrefix()">Add prefix</button>
      </div>
      <div id="prefix-alert" class="col-12" style="padding-left: 0px;">
        <div id="prefix-alert-text" class="alert alert-danger" role="alert"
          style="padding-top: 4px; padding-bottom: 4px; margin-bottom: 0px">

        </div>
      </div>
    </form>
    <hr class="mt-3">
  </div>
  <table class="table table-bordered mt-2" id="dataTable">
    <thead></thead>
    <tbody></tbody>
  </table>
</div>
{% include 'datadoc/components/dialog.html' %}
{% endblock %}
{% block scripts %}
<script>
  var columns = [];
  var rows = [];
  var prefix = [];

  {% for item in prefix_list %}
  prefix.push({prefix: '{{ item.prefix }}', iri: '{{ item.iri }}'});
  {% endfor %}

  $(document).ready(function () {
    columns = ['@id', '@type'];
    rows = [['', '']];
    updateTable();
  });


  function showTooltip(col) {
    return col === '@id' ? 'The unique identifier of a resource.' : 'Ontology concept this resource belongs to.';
  }

  function showWarning(message) {
    $('#warn-message').text(message);
    $('#warn-alert').show();
  }
  function viewPrefixes() {
    fetch("{% url 'get_prefixes' %}")
      .then(response => response.json())
      .then(data => {
        const list = document.getElementById('prefix-list');
        list.innerHTML = '';
        if (data.prefixes.length === 0) {
          list.innerHTML = '<li class="list-group-item text-muted">No prefixes available.</li>';
        } else {
          data.prefixes.forEach(p => {
            list.innerHTML += `<li class="list-group-item"><strong>${p.prefix}</strong>: ${p.iri}</li>`;
          });
        }
        new bootstrap.Modal(document.getElementById('prefixModal')).show();
      })
      .catch(err => {
        alert("Error fetching prefixes.");
      });
  }

  function generateUniqueId() {
    return 'id-' + Math.floor(Math.random() * 1000000);
  }

  function addColumn() {
    const columnName = "Column " + (columns.length + 1);
    columns.push(columnName);
    rows.forEach(row => {
      row.push('');
    });
    updateTable();
  }

  function addRow() {
    if (columns.length === 0) {
      showWarning("Please add at least one column before adding a row.");
      return;
    }
    let newRow = columns.map(col => '');
    rows.push(newRow);
    updateTable();
  }

  function getTextInput(value, onchange, readonly = false) {
    return `<input type="text" class="form-control form-control-sm" value="${value}" onchange="${onchange}" ${readonly ? 'readonly' : ''}>`;
  }

  function updateTable() {
    let header = '<tr><th></th>';
    $('#remove-column').empty();

    columns.forEach((col, colIndex) => {
      let tooltip = (col === '@id' || col === '@type') ? `data-bs-toggle="tooltip" title="${showTooltip(col)}"` : '';
      let onchange = (col !== '@id' && col !== '@type') ? `renameColumn(${colIndex}, this.value)` : '';
      let readonly = (col === '@id' || col === '@type');
      header += `<th ${tooltip}>${getTextInput(col, onchange, readonly)}</th>`;

      if (!readonly) {
        $('#remove-column').append(`<li><a class="dropdown-item" href="javascript:deleteColumn(${colIndex})">${col}</a></li>`);
      }
    });
    header += '</tr>';
    $('#dataTable thead').html(header);

    let bodyHtml = '';
    rows.forEach((row, rowIndex) => {
      bodyHtml += `<tr><td><input class="form-check-input" type="checkbox" id="row-${rowIndex}"></td>`;
      columns.forEach((col, colIndex) => {
        bodyHtml += `<td><input type="text" class="form-control form-control-sm" value="${row[colIndex]}" onchange="updateRowValue(${rowIndex}, ${colIndex}, this.value)"></td>`;
      });
      bodyHtml += '</tr>';
    });
    $('#dataTable tbody').html(bodyHtml);


    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    tooltipTriggerList.forEach(function (tooltipTriggerEl) {
      new bootstrap.Tooltip(tooltipTriggerEl)
    });

  }

  function renameColumn(colIndex, newName) {
    columns[colIndex] = newName;
    updateTable();
  }

  function deleteColumn(colIndex) {
    if (columns[colIndex] === '@id' || columns[colIndex] === '@type') {
      showWarning("Cannot delete the '@id' or '@type' columns.");
      return;
    }
    columns.splice(colIndex, 1);
    rows.forEach(row => row.splice(colIndex, 1));
    updateTable();
  }

  function deleteRows() {
    let remove = $('input[id^="row-"]:checked').map((i, inp) => Number(inp.id.substring(4))).toArray();
    rows = rows.filter((_, i) => !remove.includes(i));
    updateTable();
  }

  function updateRowValue(rowIndex, colIndex, newValue) {
    rows[rowIndex][colIndex] = newValue;
  }

  function validateTable() {
    let valid = true;
    if (columns.length === 0 || rows.length === 0) {
      showWarning("Please add some columns and rows first!");
      valid = false;
    } else {
      for (let i = 0; i < rows.length; i++) {
        for (let j = 0; j < columns.length; j++) {
          if (!rows[i][j]) {
            showWarning("Please fill in all fields before saving the CSV.");
            valid = false;
            break;
          }
        }
      }
    }
    if (valid) {
      $('#warn-alert').hide();
    }
    return valid;
  }

  function generateCSV() {
    let csvContent = '';
    if (validateTable()) {
      csvContent = columns.join(",") + "\n";
      rows.forEach(row => {
        csvContent += row.join(",") + "\n";
      });
    }
    return csvContent;
  }

  function copyCSV() {
    navigator.clipboard.writeText(generateCSV());
  }

  function submitCSV() {
    let csvContent = generateCSV();
    if (csvContent) {
      let csv_prefix = "";
      prefix.forEach(p => {
        csv_prefix += `${p.prefix}:${p.iri}\n`;
      });
      console.log(csv_prefix);
      fetch('{% url "process_csv" %}', {
        method: 'POST',
        headers: {
          'HX-Request': 'true',
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `csv_data=${encodeURIComponent(csvContent)}&csv_prefix=${encodeURIComponent(csv_prefix)}`
      })
        .then(response => response.json())
        .then(data => {
          showDialog(data.message, data.status_code);
          if (Number(data.status_code) === 200) {
            columns = ['@id', '@type'];
            rows = [['', '']];
            updateTable();
            $('#warn-alert').hide();
          }
        });
    }
  }

  function onAddPrefix() {
    $('#inp-prefix').val('');
    $('#inp-iri').val('');
    $('#prefix-alert').hide();
    $('#row-prefix').show();
  }

  function addPrefix() {
    let error = '';
    let iri = $('#inp-iri').val();
    if (!iri) {
      error = 'Prefix IRI is empty!';
    }
    let name = $('#inp-prefix').val();
    if (!name) {
      error = 'Prefix name is empty!'
    } else {
      let found = prefix.find(x => x.prefix == name);
      if (found) {
        error = `Prefix "${name}" already exists!`;
      }
    }
    if (error) {
      $('#prefix-alert-text').text(error);
      $('#prefix-alert').show();
    } else {
      $('#prefix-alert').hide();
      let item = {
        prefix: $('#inp-prefix').val(),
        iri: $('#inp-iri').val()
      };
      prefix.push(item);
      let href = `javascript:onRemovePrefix('${item.prefix}')`;
      let label = `${item.prefix}: ${item.iri}`;
      $('#prefix').append(`<li><a class="dropdown-item" href="${href}">${label}</a></li>`);
      $('#row-prefix').hide();
    }
  }

  function hidePrefix() {
    $('#row-prefix').hide();
  }

  function onRemovePrefix(name) {
    prefix = prefix.filter(x => x.prefix != name);
    let menu = '';
    menu += '<li><h6 class="dropdown-header">New prefix</h6></li>';
    menu += '<li><a class="dropdown-item" href="javascript:onAddPrefix()">Add</a></li>';
    menu += '<li><h6 class="dropdown-header">Remove prefix</h6></li>';
    prefix.forEach(item => {
      let href = `javascript:onRemovePrefix('${item.prefix}')`;
      let label = `${item.prefix}: ${item.iri}`;
      menu += `<li><a class="dropdown-item" href="${href}">${label}</a></li>`;
    });
    $('#prefix').empty().append(menu);
  }


  updateTable();
</script>


{% endblock %}