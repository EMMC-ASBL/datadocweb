{% extends 'datadoc/base.html' %}
{% block content %}
{% include 'datadoc/components/header.html' %}
<div class="container mt-4">
  <h3 class="mb-4">Documentation Form</h3>
  <div class="btn-toolbar" role="toolbar">
    <div class="btn-group btn-group-sm me-2" role="group">
      <button type="button" class="btn btn-secondary" onclick="addColumn()">
        Add column
      </button>
      <button type="button" class="btn btn-secondary" onclick="addRow()">
        Add row
      </button>
    </div>
    <div class="btn-group btn-group-sm me-2" role="group">
      <div class="btn-group btn-group-sm" role="group">
        <button type="button" class="btn btn-secondary dropdown-toggle"
                data-bs-toggle="dropdown" aria-expanded="false">
          Remove column
        </button>
        <ul class="dropdown-menu" id="remove-column"></ul>
      </div>
      <button type="button" class="btn btn-secondary"
              title="Remove the selected rows" onclick="deleteRows()">
        Remove rows
      </button>
    </div>
    <div class="btn-group btn-group-sm" role="group">
      <button id="btn-copy" type="button" class="btn btn-light" onclick="copyCSV()">
        Copy CSV
      </button>
      <button id="btn-submit" type="button" class="btn btn-success" onclick="submitCSV()">
        Submit
      </button>
    </div>
  </div>
  <div id="warn-alert" class="alert alert-warning alert-dismissible fade show mt-2" role="alert" style="display:none">
    <span id="warn-message">Message</span>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
  <table class="table table-bordered mt-2" id="dataTable">
    <thead></thead>
    <tbody></tbody>
  </table>
</div>
{% include 'datadoc/components/dialog.html' %}
<script>
  var columns = [];
  var rows = [];

  function showWarning(message) {
    $('#warn-message').text(message);
    $('#warn-alert').show();
  }

  function addColumn() {
    const columnName = "Column " + (columns.length + 1);
    columns.push(columnName);
    rows.forEach(row => {
      row.push('');
    });
    updateTable();
  }

  function addRow() {
    if (columns.length === 0) {
      showWarning("Please add at least one column before adding a row.");
      return;
    }
    rows.push(columns.map(c => ''));
    updateTable();
  }

  function getTextInput(value, onchange) {
    return `<input type="text" class="form-control form-control-sm" value="${value}" onchange="${onchange}">`;
  }

  function updateTable() {
    let header = '<tr><th></th>';
    $('#remove-column').empty();
    columns.forEach((col, colIndex) => {
      let onchange = `renameColumn(${colIndex}, this.value)`;
      header += `<th>${getTextInput(col, onchange)}</th>`;
      let item = `<li><a class="dropdown-item" href="javascript:deleteColumn(${colIndex})">${col}</a></li>`;
      $('#remove-column').append(item);
    });
    $('#dataTable thead').empty().append(header);

    let cells = '';
    rows.forEach((row, rowIndex) => {
      cells += '<tr><td><div class="form-check">';
      cells += `<input class="form-check-input" type="checkbox" id="row-${rowIndex}">`;
      cells += '</div></td>';
      columns.forEach((col, colIndex) => {
        let onchange = `updateRowValue(${rowIndex}, ${colIndex}, this.value)`;
        cells += `<td>${getTextInput(row[colIndex], onchange)}</td>`;
      });
      cells += '</tr>';
    });
    $('#dataTable tbody').empty().append(cells);
  }

  function renameColumn(colIndex, newName) {
    const oldName = columns[colIndex];
    columns[colIndex] = newName;
    updateTable();
  }

  function deleteColumn(colIndex) {
    const colName = columns[colIndex];
    columns.splice(colIndex, 1);
    rows.forEach(row => {
      row.splice(colIndex, 1);
    });
    updateTable();
  }

  function deleteRows() {
    let remove = $('input[id^="row-"]:checked').map((i, inp) => {
      return Number(inp.id.substring(4));
    }).toArray();
    var newrows = [];
    rows.forEach((row, i) => {
      if (!remove.includes(i)) {
        newrows.push(row);
      }
    });
    rows = newrows;
    updateTable();
  }

  function updateRowValue(rowIndex, colIndex, newValue) {
    rows[rowIndex][colIndex] = newValue;
  }

  function validateTable() {
    let valid = true;
    if (columns.length === 0 || rows.length === 0) {
      showWarning("Please add some columns and rows first!");
      valid = false;
    } else {
      for (let i = 0; i < rows.length; i++) {
        for (let j = 0; j < columns.length; j++) {
          if (!rows[i][j]) {
            showWarning("Please fill in all fields before saving the CSV.");
            valid = false;
            break;
          }
        }
      }
    }
    if (valid) {
      $('#warn-alert').hide();
    }
    return valid;
  }

  function generateCSV() {
    let csvContent = '';
    if (validateTable()) {
      csvContent = columns.join(",") + "\n";
      rows.forEach(row => {
        csvContent += row.join(",") + "\n";
      });    
    }
    return csvContent;
  }

  function copyCSV() {
    navigator.clipboard.writeText(generateCSV());
  }

  function submitCSV() {
    let csvContent = generateCSV();
    if (csvContent) {
      fetch('{% url "process_csv" %}', {
        method: 'POST',
        headers: {
          'HX-Request': 'true',
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `csv_data=${encodeURIComponent(csvContent)}`
      })
      .then(response => response.json())
      .then(data => {
        showDialog(data.message, data.status_code);
      });
    }
  }
</script>
{% endblock %}