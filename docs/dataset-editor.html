<!DOCTYPE html>
<html lang="en">

<head>
  <title>Dataset editor</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script type="module">
    import { nanoid } from 'https://cdn.jsdelivr.net/npm/nanoid/nanoid.js';
    window.nanoid = nanoid;
  </script>
</head>

<body>

  <div class="container-fluid mt-3">
    <h3>Dataset editor</h3>
    <div class="row">
      <div class="col-3">
        <div class="card mt-3">
          <div class="card-header">Dataset collection</div>
          <div class="card-body">
            <div class="btn-group btn-group-sm">
              <button type="button" class="btn btn-light"
                      data-bs-toggle="modal"
                      data-bs-target="#dialog-add-dataset">
                Add
              </button>
              <button type="button" class="btn btn-light">Remove</button>
              <button type="button" class="btn btn-light">Rename</button>
              <button type="button" class="btn btn-light">Import</button>
              <button type="button" class="btn btn-light">Export</button>
            </div>
            <div id="datasets" class="list-group mt-3">
              <button type="button" onclick="onShowDataset(this)" class="list-group-item list-group-item-action">My first dataset</button>
              <button type="button" onclick="onShowDataset(this)" class="list-group-item list-group-item-action">Super dataset</button>
              <button type="button" onclick="onShowDataset(this)" class="list-group-item list-group-item-action active">Hello world</button>
            </div>
          </div>
        </div>
        <div id="card-tables" class="card mt-3">
          <div class="card-header">Tables in dataset <strong>Hello world</strong></div>
          <div class="card-body">
            <div class="btn-group btn-group-sm">
              <button type="button" class="btn btn-light"
                      data-bs-toggle="modal"
                      data-bs-target="#dialog-add-table">
                Add
              </button>
              <button type="button" class="btn btn-light">Remove</button>
              <button type="button" class="btn btn-light">Rename</button>
            </div>
            <div id="tables" class="list-group mt-3">
              <button type="button" onclick="onShowTable(this)" class="list-group-item list-group-item-action active">Images</button>
              <button type="button" onclick="onShowTable(this)" class="list-group-item list-group-item-action">Alloys</button>
              <button type="button" onclick="onShowTable(this)" class="list-group-item list-group-item-action">Heat treatments</button>
            </div>
          </div>
        </div>
        <div id="card-columns" class="card mt-3 mb-3">
          <div class="card-header">Columns in table <strong>Images</strong></div>
          <div class="card-body">
            <div class="btn-group btn-group-sm">
              <button type="button" class="btn btn-light">Select and edit</button>
              <button type="button" class="btn btn-light">Add</button>
              <button type="button" class="btn btn-light">Remove</button>
            </div>
            <form>
              <div class="mb-1">
                <label for="col-name" class="form-label form-text">Column name</label>
                <input type="text" class="form-control form-control-sm" id="col-name" placeholder="Enter a name for the column">
              </div>
              <div class="mb-1">
                <label for="col-type" class="form-label form-text">Type of data</label>
                <select class="form-select form-select-sm" id="col-type">
                  <option>Text</option>
                  <option>Number</option>
                  <option>Choice</option>
                  <option>Choice from another table column</option>
                </select>
              </div>
              <div class="mb-1">
                <label for="col-choices" class="form-label form-text">Choices (if choice data type)</label>
                <textarea class="form-control form-control-sm" id="col-choices" rows="3"></textarea>
              </div>
              <div class="mb-1">
                <label for="col-type" class="form-label form-text">Concept</label>
                <select class="form-select form-select-sm" id="col-type">
                  <option>@id</option>
                  <option>@type</option>
                  <option>contact</option>
                </select>
              </div>
            </form>
          </div>
        </div>
      </div>
      <div class="col-9">
        <div class="card mt-3">
          <div class="card-header">
            Table <strong>Images</strong> in dataset <strong>Hello world</strong>
          </div>
          <div class="card-body">
            <div class="btn-group btn-group-sm">
              <button type="button" class="btn btn-light">Add rows from files</button>
              <button type="button" class="btn btn-light">Add row</button>
              <button type="button" class="btn btn-light">Remove rows</button>
            </div>
            <table class="table">
              <thead>
                <tr>
                  <th>Firstname</th>
                  <th>Lastname</th>
                  <th>Email</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>John</td>
                  <td>Doe</td>
                  <td>john@example.com</td>
                </tr>
                <tr>
                  <td>Mary</td>
                  <td>Moe</td>
                  <td>mary@example.com</td>
                </tr>
                <tr>
                  <td>July</td>
                  <td>Dooley</td>
                  <td>july@example.com</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="dialog-add-dataset" class="modal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add dataset</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form>
            <div class="mb-3">
              <label for="dataset-name" class="form-label">The name of dataset</label>
              <input type="text" class="form-control" name="name" id="dataset-name" placeholder="Enter a name" required>
              <div class="invalid-feedback">
                Please enter a name for the dataset.
              </div>                        
            </div>            
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" onclick="onCancelDialog('#dialog-add-dataset')">Cancel</button>
          <button type="button" class="btn btn-success" onclick="onSubmitDialog('#dialog-add-dataset')">Submit</button>
        </div>
      </div>
    </div>
  </div>

  <div id="dialog-remove" class="modal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Modal title</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form>
          <input type="hidden" name="datatype" value="">
          <input type="hidden" name="item" value="">
          <input type="text" name="name" value="" placeholder="Enter a name" required>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-success"></button>
      </div>
    </div>
  </div>
</div>

<script>

datasets = [
  {
    name: 'Hello World',
    tables: [
      {
        name: 'Images',
        columns: [
          {name: 'File name', type: 'text', concept: '@id'},
          {name: 'File size', type: 'number', concept: ''},
          {name: 'Author', type: 'choice', choices: ['John', 'Liv'], concept: 'author'}
        ],
        rows: [['img1.dm3', '', ''], ['img2.dm3', '', '']]
      },
      {name: 'Alloys', rows: [], columns: []},
      {name: 'Heat treatments', rows: [], columns: []},
    ]
  }
];

function getDataset() {
  let name = $('#datasets .active').text();
  return datasets.find(item => item.name == name);
}

function addDatasetButton(name) {
  let click = 'onShowDataset(this)';
  let cls = 'list-group-item list-group-item-action';
  $('#datasets').append(`<button type="button" onclick="${click}" class="${cls}">${name}</button>`);
}

function addTableButton(name) {
  let click = 'onShowTable(this)';
  let cls = 'list-group-item list-group-item-action';
  $('#tables').append(`<button type="button" onclick="${click}" class="${cls}">${name}</button>`);
}

function showDataset(name) {
  let dataset = datasets.find(item => item.name == name);
  if (dataset) {
    $('#card-tables .card-header').html(`Tables in dataset <strong>${name}</strong>`);
    $('#tables').empty();
    dataset.tables.forEach(item => {
      addTableButton(item.name);
    });
    if (dataset.tables.length > 0) {
      showTable(dataset, dataset.tables[0].name);
    }
  }
}

function showTable(dataset, tablename) {
  if (dataset) {
    var table = dataset.tables.find(item => item.name == tablename);
    if (table) {
      let th = table.columns.map(c => `<th>${c.name}</th>`).join('');
      $('#table thead').empty().append(th);
      let tr = table.rows.map(row => row.map(cell => `<td>${cell}</td>`).join(''));
      $('#table tbody').empty().append(tr.join(''));
    }
  }
}

function onShowDataset(element) {
  $('#datasets button').removeClass('active');
  element.classList.add('active');
  showDataset(element.innerText);
}

function onShowTable(element) {
  $('#tables button').removeClass('active');
  element.classList.add('active');
  showTable(getDataset(), element.innerText);
}

function clearForm(form) {
  let f = $(form);
  if (f.length == 1) {
    let elements = f[0].elements;
    for (let i = 0; i < elements.length; i++) {
      let el = elements[i];
      if (el.type != "hidden") {
        if ((el.type == "checkbox") || (el.type == "radio")) {
          el.checked = false;
        } else {
          el.value = '';
        }
      }
    }
    f[0].classList.replace('was-validated', 'needs-validation');
  }
}

function onCancelDialog(dialog) {
  clearForm(`${dialog} form`);
  $(dialog).modal('hide');
}

function onSubmitDialog(dialog) {
  let form_id = `${dialog} form`;
  let form = $(form_id)[0];
  let valid = form.checkValidity();
  form.classList.add('was-validated');
  let data = {};
  if (valid) {    
    $(form_id).serializeArray().forEach(item => {
      data[item.name] = item.value;
    });
    if (dialog == '#dialog-add-dataset') {
      datasets.push({name: data.name, tables: []});
      addDatasetButton(data.name);
    }
    else if (dialog == '#dialog-add-table') {
      let dataset = getDataset();
      if (dataset) {
        dataset.tables.push({name: data.name, columns: [], rows: []});
        addTableButton(data.name);
      }
    }
    clearForm(form_id);
    $(dialog).modal('hide');
  }
}

$(document).ready(function() {
  let dlg = $('#dialog-add-dataset').html().replaceAll('dataset', 'table');
  $('body').append(`<div id="dialog-add-table" class="modal" tabindex="-1">${dlg}</div`);
  $('#datasets').empty();
  datasets.forEach(item => { addDatasetButton(item.name); });
  showDataset('Hello World');
  $('#datasets button')[0].classList.add('active');
});
</script>

</body>

</html>