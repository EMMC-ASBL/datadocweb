{% extends "content.html" %}
{% block title %} - Register data{% endblock %}
{% block content %}
<div class="container" style="margin-top:80px">
  <div class="row">
    <div class="col" style="padding-right: 0px;">
      <div class="card">
        <div class="card-header">
          Register data
        </div>
        <div class="card-body">
          <form role="form" method="post" action="{% url 'datadocweb:register' %}"
                enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" name="part" id="part" value="">
            <div class="mb-3 mt-3"> 
              <label for="file-report" class="form-label"> 
                Main report
              </label> 
              <input class="form-control" type="file" id="file-report"
                     name="report" accept=".xls,.xlsx" onchange="onReadReport()">
            </div>
            <div class="mb-3 mt-3"> 
              <label for="file-tensile" class="form-label"> 
                Tensile test result
              </label> 
              <input class="form-control" type="file" id="file-tensile"
                     name="tensile" accept=".xls,.xlsx" onchange="onReadTensile()">
            </div>
            <div class="mb-3 mt-3"> 
              <label for="file-buckling" class="form-label"> 
                Buckling test result
              </label> 
              <input class="form-control" type="file" id="file-buckling"
                     name="buckling" accept=".xls,.xlsx" onchange="onReadBuckling()">
            </div>
            <button type="submit" class="btn btn-success" disabled>Upload</button>          
          </form>
        </div>
      </div>
    </div>
    <div class="col" style="padding-right: 0px;">
      <div class="card">
        <div class="card-header">
          Main Report
        </div>
        <table class="table" id="table-report">
          <tbody>
            <tr><td>Part No.</td><td></td></tr>
            <tr><td>Document No.</td><td></td></tr>
            <tr><td>Charge No.</td><td></td></tr>
            <tr><td>Configuration</td><td></td></tr>
            <tr><td>Date</td><td></td></tr>
            <tr><td>Reported tensile tests</td><td>0</td></tr>
            <tr><td>Reported buckling test</td><td>0</td></tr>
            </tr>
          </tbody>        
        </table>
      </div>
    </div>
    <div class="col">
      <div class="card">
        <div class="card-header">
          Test results
        </div>
        <table class="table" id="table-results">
          <thead>
            <tr><th>File</th><th>Test</th><th>Name</th><th>Value</th><th>Reported</th></tr>
          </thead>
          <tbody>
          </tbody>        
        </table>
      </div>
    </div>
  </div>
  <div class="btn-group btn-group-sm" role="group" aria-label="Search data"
       style="margin-top:10px">
    <a href="{% url 'raufossdb:home' %}" class="btn btn-primary">
      <i class="bi bi-search"></i> Go back to search test data
    </a>
  </div>
  <input type="hidden" id="report-data" value="">
</div>
{% endblock %}
{% block javascript %}
{{ block.super }}
function Workbook(content, sheet) {
  this.wb = XLSX.read(content, {type: 'array'});
  this.ws = null;
  if (sheet)
    this.sheet(sheet);
}
Workbook.prototype.exists = function(name) {
  return this.wb.SheetNames.indexOf(name) >= 0;
}
Workbook.prototype.sheet = function(name) {
  this.ws = this.exists(name) ? this.wb.Sheets[name] : null;
  return this.ws
}
Workbook.prototype.range = function() {
  return XLSX.utils.decode_range(this.ws['!ref']);
}
Workbook.prototype.col_values = function(col, start, end) {
  var ws = this.ws;
  var values = [];
  var a = this.range(ws);
  if (Number.isFinite(end)) {
    if (end <= 0)
      end += a.e.r;
  }
  else
    end = a.e.r;
  for (var r = start; r <= end; r++) {
    var cell = ws[XLSX.utils.encode_cell({ r: r, c: col })]
    if (cell) {
      if (cell.t != 'e')
        values.push(cell.v);
      else
        break;
    }
    else
      break;
  }
  return values;
}
Workbook.prototype.row_values = function(row, start, end) {
  var ws = this.ws;
  var values = [];
  var a = this.range(ws);
  if (Number.isFinite(end)) {
    if (end <= 0)
      end += a.e.c;
  }
  else
    end = a.e.c;
  for (var c = start; c <= end; c++) {
    var cell = ws[XLSX.utils.encode_cell({ r: row, c: c })]
    values.push(cell ? (cell.t != 'e' ? cell.v : null) : null)
  }
  return values;
}
Workbook.prototype.cell = function(row, col) {
  var cell = null;
  if (typeof(row) == 'string') {
    cell = this.ws[row]
  } else {
    cell = this.ws[XLSX.utils.encode_cell({r: row, c: col})];
  }
  return cell;
}
Workbook.prototype.cell_value = function(row, col, p) {
  var cell = this.cell(row, col);
  return cell ? (p ? cell[p] : cell.v) : '';
}
Workbook.prototype.cell_empty = function(row, col) {
  var cell = this.cell(row, col);
  // console.log(row, col, cell);
  return cell ? cell.w.length == 0 : true;
}
Workbook.prototype.copy_cell = function(cell, table, row, col, p) {
  table.rows[row].cells[col].innerHTML = this.cell_value(cell, 0, p);
}
function onReadExcel(name, onread) {
  var inp = $('#file-' + name)[0];
  if (inp.files.length > 0) {
    var i = inp.files.length - 1;
    var file = inp.files[i];
    var reader = new FileReader();
    reader.onload = function(event) {
      var wb = new Workbook(reader.result);
      onread(file.name, wb);
    }
    reader.readAsArrayBuffer(file);
  }
}
function onReadReport() {
  onReadExcel('report', (filename, wb) => {
    if (wb.sheet('Archive')) {
      var table = $('#table-report')[0];
      var cells = ['D3', 'B11', 'B12'];
      cells.forEach((cell, i) => { wb.copy_cell(cell, table, i + 1, 1); });
      wb.copy_cell('J9', table, 4, 1, 'w');
      var tensile = ['D35', 'D36', 'D37'];
      var n = tensile.reduce(
        (acc, cell) => wb.cell_empty(cell) ? acc : acc + 1,
        0
      );
      table.rows[5].cells[1].innerHTML = n;
      table.rows[6].cells[1].innerHTML = wb.cell_empty('F40') ? 0 : 1;

      tensile = ['I35', 'I36', 'I37'];
      var data = {
        name: filename,
        tensile: tensile.map(cell => wb.cell_value(cell)),
        buckling: wb.cell_value('F40')
      };
      $('#report-data').val(JSON.stringify(data));
      var part = '' + wb.cell_value('F11');
      part += wb.cell_value('G11');
      part += wb.cell_value('H11');
      table.rows[0].cells[1].innerHTML = '<i>check part number</i>';
      table.rows[0].className = '';
      $.get('{% url 'raufossdb:register' %}?part=' + part, data => {
        if (data.uuid) {
          table.rows[0].cells[1].innerHTML = part;
          table.rows[0].className = 'table-success';
          $('#part').val(data.uuid);
        } else {
          table.rows[0].cells[1].innerHTML = part + ' (not found)';
          table.rows[0].className = 'table-danger';
        }         
      }, 'json');
    }
  });
}
function addTestResult(row) {
  var td = row.map(x => '<td>' + x + '</td>');
  var tr = '<tr>' + td.join('') + '</tr>';
  $('#table-results tbody').append(tr);
}
function getReportData(name) {
  var report = $('#report-data').val();
  var value = '';
  if (report.startsWith('{') > 0) {
    var data = JSON.parse(report);
    value = data[name] ? data[name] : '';
  }
  return value;
}
function find_max(arr) {
  let ma = null;
  if (Array.isArray(arr)) {
    if (arr.length > 0) {
      for(let i=0; i < arr.length; i++) {
        if (Number.isFinite(arr[i])) {
          if (ma == null) {
            ma = arr[i];
          } else if (arr[i] > ma) {
            ma = arr[i]
          }
        }
      }
    }
  }
  return ma;
}
function onReadTensile() {
  onReadExcel('tensile', (filename, wb) => {  
    if (wb.sheet('Results')) {
      var spec = wb.cell_value('A3');
      if (wb.sheet(spec)) {
        // var strain = wb.col_values(0, 0);
        var stress = wb.col_values(1, 0);
        if (stress.length >= 2) {
          var rm = find_max(stress);
          var rm_str = Number.isFinite(rm) ? rm.toFixed(1) + 'MPa' : '-';
          var reported = getReportData('tensile');
          var r = '';
          if (reported.length > 0) {
            r = reported[0] + 'MPa';
          }
          addTestResult([filename, 'Tensile', 'Rm', rm_str, r]);
        }
      }
    }
  });
}
function onReadBuckling() {
  onReadExcel('buckling', (filename, wb) => {  
    if (wb.sheet('Results')) {
      var spec = wb.cell_value('A3');
      if (wb.sheet(spec)) {
        var force = wb.col_values(1, 3);
        if (force.length >= 2) {
          var fm = force.reduce((ma,va) => Math.max(ma, va), force[0]) / 1000;
          var reported = getReportData('buckling');
          addTestResult([filename, 'Buckling', 'Max.Force', fm.toFixed(1) + 'kN', reported]);
        }
      }
    }
  });
}
{% endblock %}